<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />

    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#1a0f2e" />
    <meta name="format-detection" content="telephone=no" />

    <title>XV Renata — Wonderland AR ✨</title>

    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- WebRTC Adapter -->
    <script src="https://cdn.jsdelivr.net/npm/webrtc-adapter@8.2.2/out/adapter.min.js"></script>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <!-- MindAR Face -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-face-aframe.prod.js"></script>

    <!-- html2canvas (fallback captura) -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- Fuentes -->
    <link
      href="https://fonts.googleapis.com/css2?family=Creepster&family=New+Rocker&family=Nosifer&family=Butcherman&family=Eater&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="css/styles.css" />
    <link rel="icon" type="image/x-icon" href="images/favicon.ico" />

    <!-- ===== COMPONENTES PARA GLB ===== -->
    <script>
      // Ajusta modelo GLB a un tamaño "humano" y lo recentra
      AFRAME.registerComponent('fit-gltf', {
        schema: {
          targetSize: { type: 'number', default: 0.22 }, // tamaño final aprox
          yOffset: { type: 'number', default: 0.0 }, // extra arriba/abajo si ocupas
        },
        init() {
          this.el.addEventListener('model-loaded', () => {
            const obj = this.el.getObject3D('mesh');
            if (!obj) return;

            obj.updateMatrixWorld(true);

            const box = new THREE.Box3().setFromObject(obj);
            const size = new THREE.Vector3();
            box.getSize(size);

            const maxDim = Math.max(size.x, size.y, size.z || 0.0001);
            const scale = this.data.targetSize / maxDim;
            obj.scale.setScalar(scale);

            // recalcula bounds después de escalar
            const box2 = new THREE.Box3().setFromObject(obj);
            const center = new THREE.Vector3();
            box2.getCenter(center);

            // centra en 0,0,0
            obj.position.sub(center);

            // sube para que el "suelo" del modelo quede en y=0
            const box3 = new THREE.Box3().setFromObject(obj);
            obj.position.y -= box3.min.y;

            // offset final
            obj.position.y += this.data.yOffset;
          });
        },
      });

      // Fuerza material unlit con color sólido (evita que se vea negra en móviles)
      AFRAME.registerComponent('recolor-gltf', {
        schema: { color: { type: 'color', default: '#8A9B0F' } }, // verde estilo imagen
        init() {
          this.el.addEventListener('model-loaded', () => {
            const obj = this.el.getObject3D('mesh');
            if (!obj) return;

            const col = new THREE.Color(this.data.color);

            obj.traverse(node => {
              if (node.isMesh) {
                node.material = new THREE.MeshBasicMaterial({
                  color: col,
                  transparent: true,
                  opacity: 1,
                  side: THREE.DoubleSide,
                });
                node.material.needsUpdate = true;
              }
            });
          });
        },
      });
    </script>
  </head>

  <body>
    <!-- Loading Screen -->
    <div
      id="loading-screen"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a0f2e 0%, #2a1a4a 50%, #1f1540 100%);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        font-family: 'Creepster', cursive;
      "
    >
      <h2
        style="font-size: 2rem; margin-bottom: 20px; text-shadow: 0 0 20px rgba(138, 76, 255, 0.8)"
      >
        Preparando Wonderland...
      </h2>
      <div
        style="
          width: 200px;
          height: 4px;
          background: rgba(255, 255, 255, 0.2);
          border-radius: 2px;
          overflow: hidden;
        "
      >
        <div
          style="
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #8a4cff, #ff64c8);
            animation: loadingBar 2s ease-in-out;
          "
        ></div>
      </div>
      <style>
        @keyframes loadingBar {
          0% {
            width: 0%;
          }
          100% {
            width: 100%;
          }
        }
      </style>
    </div>

    <!-- UI Overlay -->
    <div
      id="ui-layer"
      style="
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 5;
      "
    >
      <div class="decorative-frame frame-top">
        <div class="frame-corner frame-tl">✦</div>
        <div class="frame-corner frame-tr">✦</div>
        <div class="frame-line"></div>
      </div>

      <div class="decorative-frame frame-bottom">
        <div class="frame-corner frame-bl">✦</div>
        <div class="frame-corner frame-br">✦</div>
        <div class="frame-line"></div>
      </div>

      <div class="title-overlay">
        <h1 class="title-main">
          <span class="word-xv">XV</span>
          <span class="word-renata">Renata</span>
        </h1>
        <p class="title-sub">1 de Octubre 2027</p>
      </div>

      <div class="wonderland-logo">
        <p class="wonderland-text">
          <span class="alice-word">Alice</span>
          <span class="in-word">in</span>
          <span class="wonderland-word">Wonderland</span>
        </p>
      </div>

      <div class="cheshire-cats-container">
        <div class="cheshire-cat cheshire-main">
          <img src="images/gato.png" alt="Cheshire Cat" class="cheshire-img" loading="eager" />
        </div>
        <div class="cheshire-cat cheshire-ghost-1">
          <img
            src="images/gato.png"
            alt="Cheshire Cat Ghost"
            class="cheshire-img"
            loading="eager"
          />
        </div>
        <div class="cheshire-cat cheshire-ghost-2">
          <img
            src="images/gato.png"
            alt="Cheshire Cat Ghost"
            class="cheshire-img"
            loading="eager"
          />
        </div>
      </div>

      <div class="wonderland-quote">
        <p>"We're all mad here"</p>
      </div>
    </div>

    <!-- Botón captura -->
    <div style="position: absolute; bottom: 25px; width: 100%; text-align: center; z-index: 20">
      <button id="capture-btn" class="capture-button" aria-label="Tomar foto" type="button">
        <div class="capture-ring"></div>
        <div class="capture-ring-outer"></div>
        <svg
          width="32"
          height="32"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <circle cx="12" cy="12" r="10" />
          <circle cx="12" cy="12" r="3" />
        </svg>
      </button>
    </div>

    <div id="flash" class="flash-overlay"></div>
    <div id="download-notification" class="download-notification">✨ ¡Foto capturada! ✨</div>

    <!-- ===== ESCENA AR ===== -->
    <a-scene
      id="ar-scene"
      mindar-face="
        autoStart: true;
        filterMinCF: 0.0001;
        filterBeta: 1000;
        faceOccluder: false"
      renderer="
        colorManagement: true;
        physicallyCorrectLights: false;
        preserveDrawingBuffer: true;
        alpha: true;
        sortObjects: true;"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      embedded
      loading-screen="enabled: false"
    >
      <a-assets timeout="10000">
        <a-asset-item id="new-crown" src="crown_model.glb"></a-asset-item>
      </a-assets>

      <!-- Cámara -->
      <a-camera active="true" position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Anchor -->
      <a-entity
        id="face-anchor"
        mindar-face-target="anchorIndex: 168"
        keep-visible="fadeTime: 500; minOpacity: 0.7"
      >
        <!-- CORONA: más arriba, centrada, menor tamaño -->
        <a-entity id="crown-container" position="0 0.95 -0.15" rotation="-5 0 0" scale="1 1 1">
          <a-gltf-model
            id="crown-model"
            src="#new-crown"
            fit-gltf="targetSize: 0.22; yOffset: 0.0"
            recolor-gltf="color: #8A9B0F"
          ></a-gltf-model>
        </a-entity>

        <!-- Cartas -->
        <a-entity
          position="-0.6 -0.3 0"
          rotation="0 20 -15"
          scale="0.8 0.8 0.8"
          animation="property: position; to: -0.6 -0.25 0; dur: 2000; loop: true; dir: alternate;"
        >
          <a-box width="0.15" height="0.22" depth="0.01" color="white"></a-box>
          <a-text
            value="♥"
            color="#EC5B7E"
            align="center"
            width="0.6"
            position="0 0 0.006"
          ></a-text>
        </a-entity>

        <a-entity
          position="0.6 -0.3 0"
          rotation="0 -20 15"
          scale="0.8 0.8 0.8"
          animation="property: position; to: 0.6 -0.25 0; dur: 2200; loop: true; dir: alternate;"
        >
          <a-box width="0.15" height="0.22" depth="0.01" color="white"></a-box>
          <a-text
            value="♣"
            color="#1a0f2e"
            align="center"
            width="0.6"
            position="0 0 0.006"
          ></a-text>
        </a-entity>
      </a-entity>

      <!-- Luz suave (aunque la corona ya no depende de esto) -->
      <a-light type="ambient" intensity="1.2" color="#ffffff"></a-light>
    </a-scene>

    <script src="js/app.js"></script>

    <script>
      window.addEventListener('load', () => {
        setTimeout(() => {
          const loadingScreen = document.getElementById('loading-screen');
          if (loadingScreen) {
            loadingScreen.style.transition = 'opacity 0.5s';
            loadingScreen.style.opacity = '0';
            setTimeout(() => loadingScreen.remove(), 500);
          }
        }, 2000);
      });
    </script>
  </body>
</html>
